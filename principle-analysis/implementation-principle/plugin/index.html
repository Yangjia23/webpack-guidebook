<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/webpack-guidebook/umi.css" />
    <script>
      window.routerBase = "/webpack-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.20
    </script>
    <title>Plugin 机制</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//">Webpack Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/webpack-guidebook//basic-summary">基本综述</a><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a><a href="/webpack-guidebook//best-practice">最佳实践</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//"></a><h1>Webpack Guidebook</h1><p>Webpack 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/webpack-guidebook//basic-summary">基本综述</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a></li><li><a href="/webpack-guidebook//best-practice">最佳实践</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/webpack-guidebook//principle-analysis/babel">Babel</a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle">工作原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/operational-principle/file-watch"><span>文件监听</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement"><span>模块热更新</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/filenames-hashes"><span>文件指纹策略</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking"><span>Tree Shaking</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting"><span>作用域提升</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/sourcemap"><span>SourceMap</span></a></li></ul></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/implementation-principle">底层原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/workflow"><span>构建流程</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/simple-implementation"><span>简易实现</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/source-code-analysis"><span>源码分析</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/tapable"><span>Tapable</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compiler"><span>Compiler</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compilation"><span>Compilation</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader"><span>Loader 机制</span></a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/implementation-principle/plugin"><span>Plugin 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/ast"><span>抽象语法树</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="插件的基本结构" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#插件的基本结构"><span>插件的基本结构</span></a></li><li title="构建流程" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#构建流程"><span>构建流程</span></a></li><li title="理解事件流机制 Tapable" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#理解事件流机制-tapable"><span>理解事件流机制 Tapable</span></a></li><li title="Tapable 用法" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#tapable-用法"><span>Tapable 用法</span></a></li><li title="实现简易同步钩子" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#实现简易同步钩子"><span>实现简易同步钩子</span></a></li><li title="Tapable 如何与插件关联" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#tapable-如何与插件关联"><span>Tapable 如何与插件关联</span></a></li><li title="理解 Compiler 负责编译" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#理解-compiler-负责编译"><span>理解 Compiler 负责编译</span></a></li><li title="理解 Compilation 负责创建 bundle" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#理解-compilation-负责创建-bundle"><span>理解 Compilation 负责创建 bundle</span></a></li><li title="Compiler 和 Compilation 的区别" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#compiler-和-compilation-的区别"><span>Compiler 和 Compilation 的区别</span></a></li><li title="常用 API" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#常用-api"><span>常用 API</span></a></li><li title="读取输出资源、代码块、模块及其依赖" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#读取输出资源、代码块、模块及其依赖"><span>读取输出资源、代码块、模块及其依赖</span></a></li><li title="监听文件变化" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#监听文件变化"><span>监听文件变化</span></a></li><li title="修改输出资源" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#修改输出资源"><span>修改输出资源</span></a></li><li title="判断 Webpack 使用了哪些插件" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#判断-webpack-使用了哪些插件"><span>判断 Webpack 使用了哪些插件</span></a></li><li title="文件写入" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#文件写入"><span>文件写入</span></a></li><li title="异常或警告处理" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#异常或警告处理"><span>异常或警告处理</span></a></li><li title="插件扩展：编写插件的插件" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#插件扩展：编写插件的插件"><span>插件扩展：编写插件的插件</span></a></li><li title="开发调试" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin#开发调试"><span>开发调试</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="plugin-机制"><a aria-hidden="true" href="#plugin-机制"><span class="icon icon-link"></span></a>Plugin 机制</h1><p>通过插件我们可以扩展 webpack，在合适的时机通过 Webpack 提供的 API 改变输出结果，使 Webpack 可以执行更广泛的任务，拥有更强的构建能力。</p><p>本文将尝试探索 Webpack 插件的工作流程，进而去揭秘它的工作原理。同时需要你对 Webpack 底层和构建流程的一些东西有一定的了解。</p><p>想要了解 webpack 的插件的机制，需要弄明白以下几个知识点：</p><ol><li>一个简单的插件的构成</li><li>Webpack 构建流程</li><li>Tapable 是如何把各个插件串联到一起的</li><li><code>compiler</code> 以及 <code>compilation</code> 对象的使用以及它们对应的事件钩子。</li></ol><h2 id="插件的基本结构"><a aria-hidden="true" href="#插件的基本结构"><span class="icon icon-link"></span></a>插件的基本结构</h2><p><code>plugins</code> 是可以用自身原型方法 <code>apply</code> 来实例化的对象。<code>apply</code> 只在安装插件被 Webpack 的 <code>compiler</code> 执行一次。<code>apply</code> 方法传入一个 webpck <code>compiler</code> 的引用，来访问编译器回调。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="class HelloPlugin {
  // 在构造函数中获取用户给该插件传入的配置
  constructor(options) {
    // ...
  }

  // Webpack 会调用 HelloPlugin 实例的 apply 方法给插件实例传入 compiler 对象
  apply(compiler) {
    // 在 emit 阶段插入钩子函数，用于特定时机处理额外的逻辑
    compiler.hooks.emit.tap(&#x27;HelloPlugin&#x27;, compilation =&gt; {
      // 在功能流程完成后可以调用 Webpack 提供的回调函数
    });

    // 如果事件是异步的，会带两个参数，第二个参数为回调函数，在插件处理完成任务时需要调用回调函数通知 Webpack，才会进入下一个处理流程
    compiler.plugin(&#x27;emit&#x27;, function(compilation, callback) {
      // 支持处理逻辑
      // 处理完毕后执行 callback 以通知 Webpack
      // 如果不执行 callback，运行流程将会一致卡在这不往下执行
      callback();
    });
  }
}

module.exports = HelloPlugin;
" data-status="copy"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">HelloPlugin</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 在构造函数中获取用户给该插件传入的配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Webpack 会调用 HelloPlugin 实例的 apply 方法给插件实例传入 compiler 对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 在 emit 阶段插入钩子函数，用于特定时机处理额外的逻辑</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">emit</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span><span class="token string">&#x27;HelloPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">compilation</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 在功能流程完成后可以调用 Webpack 提供的回调函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果事件是异步的，会带两个参数，第二个参数为回调函数，在插件处理完成任务时需要调用回调函数通知 Webpack，才会进入下一个处理流程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    compiler</span><span class="token punctuation">.</span><span class="token method function property-access">plugin</span><span class="token punctuation">(</span><span class="token string">&#x27;emit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 支持处理逻辑</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 处理完毕后执行 callback 以通知 Webpack</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 如果不执行 callback，运行流程将会一致卡在这不往下执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">HelloPlugin</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>使用插件时，只需要将它的实例放到 Webpack 的 Plugins 数组配置中：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const HelloPlugin = require(&#x27;./hello-plugin.js&#x27;);

module.exports = {
  plugins: [new HelloPlugin({ options: true })],
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">HelloPlugin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./hello-plugin.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">HelloPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> options</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>先来分析以下 Webpack Plugin 的工作原理：</p><ol><li>读取配置的过程中会先执行 <code>new HelloPlugin(options)</code> 初始化一个 <code>HelloPlugin</code> 获得其实例</li><li>初始化 <code>compiler</code> 对象后调用 <code>HelloPlugin.apply(compiler)</code> 给插件实例传入 <code>compiler</code> 对象</li><li>插件实例在获取到 <code>compiler</code> 对象后，就可以通过 <code>compiler.plugin(事件名称, 回调函数)</code> 监听到 Webpack 广播出来的事件，并且可以通过 <code>compiler</code> 对象去操作 Webpack</li></ol><h2 id="构建流程"><a aria-hidden="true" href="#构建流程"><span class="icon icon-link"></span></a>构建流程</h2><p>在编写插件之前，还需要了解以下 Webpack 的构建流程，以便在合适的时机插入合适的插件逻辑。</p><p>Webpack 的基本构建流程如下：</p><ol><li>校验配置文件：读取命令行传入或者 <code>webpack.config.js</code> 文件，初始化本次构建的配置参数</li><li>生成 <code>Compiler</code> 对象：执行配置文件中的插件实例化语句 <code>new MyWebpackPlugin()</code>，为 Webpack 事件流挂上自定以 Hooks</li><li>进入 <code>entryOption</code> 阶段：Webpack 开始读取配置的 Entries，递归遍历所有的入口文件</li><li><code>run/watch</code>：如果运行在 <code>watch</code> 模式则执行 <code>watch</code> 方法，否则执行 <code>run</code> 方法</li><li><code>compilation</code>：创建 <code>Compilation</code> 对象回调 <code>compilation</code> 相关钩子，依次进入每个入口文件（<code>entry</code>），使用 loader 对文件进行编译。通过 <code>compilation</code> 可以读取到 <code>module</code> 的 <code>resource</code>（资源路径）、<code>loaders</code>（使用到的 loader）等信息。再将编译好的文件内容使用 <code>acorn</code> 解析生成 AST 静态语法树。然后递归、重复的执行这个过程，所有模块和依赖分析完成后，执行 <code>compilation</code> 的 <code>seal</code> 方法对每个 Chunk 进行整理、优化、封装 <code>__webpack_require__</code> 来模拟模块化操作</li><li><code>emit</code>：所有文件的编译及转化都已经完成，包含了最终输出的资源，我们可以在传入事件回调的 <code>compilation.assets</code> 上拿到所需数据，其中包括即将输出的资源、代码块 Chunk 等信息</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 修改或添加资源
compilation.assets[&#x27;net-file.js&#x27;] = {
  source() {
    return &#x27;var a=1&#x27;;
  },
  size() {
    return this.source().length;
  },
};
" data-status="copy"></button><div class="token-line"><span class="token comment">// 修改或添加资源</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compilation</span><span class="token punctuation">.</span><span class="token property-access">assets</span><span class="token punctuation">[</span><span class="token string">&#x27;net-file.js&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;var a=1&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="7"><li><code>afterEmit</code>：文件已经写入磁盘完成</li><li><code>done</code>：完成编译</li></ol></div><img alt="Webpack执行流程" src="/webpack-guidebook/static/webpack-compile-workflow.914d192d.jpeg" width="640"/><div class="markdown"><p><a href="https://blog.didiyun.com/index.php/2019/03/01/webpack/" target="_blank" rel="noopener noreferrer">Webpack 编译流程图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="理解事件流机制-tapable"><a aria-hidden="true" href="#理解事件流机制-tapable"><span class="icon icon-link"></span></a>理解事件流机制 Tapable</h2><p>Webpack 本质上是一种事件流的机制，它的工作流程就是将各个插件串联起来，而实现这一切的核心就是 Tapable。</p><p>Webpack 的 Tapable 事件流机制保证了插件的有序性，将各个插件串联起来，Webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能假如到这条 Webpack 机制中，去改变 Webpack 的运作，使得整个系统扩展性良好。</p><p><code>Tapable</code> 也是一个小型的 library，是 Webpack 的核心工具。类似于 Node 中的 <code>events</code> 库，核心原理就是一个订阅发布模式。作用是提供类似的插件接口。</p><p>Webpack 中最核心的 <strong>负责编译的 Compiler</strong> 和 <strong>负责 bundles 的 Compilation</strong> 都是 <code>Tapable</code> 的实例，可以直接在 Compiler 和 Compilation 对象上广播和监听事件，方法如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="/**
 * 广播事件
 * event-name 为事件名称，注意不要和现有的事件重名
 */
compiler.apply(&#x27;event-name&#x27;, params);
compilation.apply(&#x27;event-name&#x27;, params);

/**
 * 监听事件
 */
compiler.plugin(&#x27;event-name&#x27;, function(params) {});
compilation.plugin(&#x27;event-name&#x27;, function(params) {});
" data-status="copy"></button><div class="token-line"><span class="token doc-comment comment">/**</span></div><div class="token-line"><span class="token doc-comment comment"> * 广播事件</span></div><div class="token-line"><span class="token doc-comment comment"> * event-name 为事件名称，注意不要和现有的事件重名</span></div><div class="token-line"><span class="token doc-comment comment"> */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token string">&#x27;event-name&#x27;</span><span class="token punctuation">,</span><span class="token plain"> params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compilation</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token string">&#x27;event-name&#x27;</span><span class="token punctuation">,</span><span class="token plain"> params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token doc-comment comment"></span></div><div class="token-line"><span class="token doc-comment comment">/**</span></div><div class="token-line"><span class="token doc-comment comment"> * 监听事件</span></div><div class="token-line"><span class="token doc-comment comment"> */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token method function property-access">plugin</span><span class="token punctuation">(</span><span class="token string">&#x27;event-name&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compilation</span><span class="token punctuation">.</span><span class="token method function property-access">plugin</span><span class="token punctuation">(</span><span class="token string">&#x27;event-name&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>Tapable</code> 类暴露了 <code>tap</code>、<code>tapAsync</code> 和 <code>tapPromise</code> 方法，可以根据钩子的同步/异步方式来选择一个函数注入逻辑。</p><p>🌰 <strong><code>tap</code> 同步钩子</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="compiler.hooks.compile.tap(&#x27;MyPlugin&#x27;, params =&gt; {
  console.log(&#x27;以同步方式触及 compile 钩子。&#x27;);
});
" data-status="copy"></button><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">compile</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span><span class="token string">&#x27;MyPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">params</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;以同步方式触及 compile 钩子。&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>🌰 <strong><code>tapAsync</code> 异步钩子</strong></p><p>通过 <code>callback</code> 回调告诉 Webpack 异步执行完毕 <code>tapPromise</code> 异步钩子，返回一个 Promise 告诉 Webpack 异步执行完毕。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="compiler.hooks.run.tapAsync(&#x27;MyPlugin&#x27;, (compiler, callback) =&gt; {
  console.log(&#x27;以异步方式触及 run 钩子。&#x27;);
  callback();
});

compiler.hooks.run.tapPromise(&#x27;MyPlugin&#x27;, compiler =&gt; {
  return new Promise(resolve =&gt; setTimeout(resolve, 1000)).then(() =&gt; {
    console.log(&#x27;以具有延迟的异步方式触及 run 钩子&#x27;);
  });
});
" data-status="copy"></button><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">run</span><span class="token punctuation">.</span><span class="token method function property-access">tapAsync</span><span class="token punctuation">(</span><span class="token string">&#x27;MyPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;以异步方式触及 run 钩子。&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">run</span><span class="token punctuation">.</span><span class="token method function property-access">tapPromise</span><span class="token punctuation">(</span><span class="token string">&#x27;MyPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">compiler</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;以具有延迟的异步方式触及 run 钩子&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="tapable-用法"><a aria-hidden="true" href="#tapable-用法"><span class="icon icon-link"></span></a>Tapable 用法</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const {
  SyncHook,
  SyncBailHook,
  SyncWaterfallHook,
  SynLoopHook,
  AsyncParallelHook,
  AsyncParallelBailHook,
  AsyncSeriesHook,
  ASyncSeriesBailHook,
  AsyncSeriesWaterfallHook,
} = require(&#x27;tapable&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">SyncHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">SyncBailHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">SyncWaterfallHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">SynLoopHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">AsyncParallelHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">AsyncParallelBailHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ASyncSeriesBailHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;tapable&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>Sync*</code> 同步<ul><li><code>SyncHook</code> 同步钩子</li><li><code>SyncBailHook</code> 同步保险钩子</li><li><code>SyncLoopHook</code> 同步循环钩子</li><li><code>SyncWaterfallHook</code> 同步瀑布钩子</li></ul></li><li><code>Async*</code> 异步<ul><li><code>AsyncParallel*</code> 异步并行<ul><li><code>AsyncParallelHook</code> 异步</li><li><code>AsyncParallelBailHook</code> 异步并行保险钩子</li></ul></li><li><code>AsyncSeries*</code> 异步串行<ul><li><code>AsyncSeriesHook</code> 异步串行钩子</li><li><code>AsyncSeriesBailHook</code> 异步串行保险钩子</li><li><code>AsyncSeriesWaterfallHook</code> 异步串行瀑布钩子</li></ul></li></ul></li></ul><h3 id="实现简易同步钩子"><a aria-hidden="true" href="#实现简易同步钩子"><span class="icon icon-link"></span></a>实现简易同步钩子</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="class Hook {
  constructor(args) {
    this.taps = [];
    this.interceptors = []; // 这个放在后面用
    this._args = args;
  }
  tap(name, fn) {
    this.taps.push({ name, fn });
  }
}

class SyncHook extends Hook {
  call(name, fn) {
    try {
      this.taps.forEach(tap =&gt; tap.fn(name));
      fn(null, name);
    } catch (error) {
      fn(error);
    }
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Hook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">taps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 这个放在后面用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_args</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> args</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token parameter punctuation">,</span><span class="token parameter"> fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">taps</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> name</span><span class="token punctuation">,</span><span class="token plain"> fn </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">Hook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token parameter punctuation">,</span><span class="token parameter"> fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">taps</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">tap</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> tap</span><span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token plain">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="tapable-如何与插件关联"><a aria-hidden="true" href="#tapable-如何与插件关联"><span class="icon icon-link"></span></a>Tapable 如何与插件关联</h3><p><strong>Compile.js</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const { AsyncSeriesHook, SyncHook } = require(&#x27;tapable&#x27;);

// 创建类
class Compiler {
  constructor() {
    this.hooks = {
      // 异步钩子
      run: new AsyncSeriesHook([&#x27;compiler&#x27;]),
      // 同步钩子
      compile: new SyncHook([&#x27;params&#x27;]),
    };
  }

  run() {
    // 执行异步钩子
    this.hooks.run.callAsync(this, err =&gt; {
      this.compile(onCompiled);
    });
  }

  compile() {
    // 执行同步钩子 并传参
    this.hooks.compile.call(params);
  }
}

module.exports = Compile;
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;tapable&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 创建类</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Compiler</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 异步钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compiler&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 同步钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      compile</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;params&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 执行异步钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">run</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token plain">onCompiled</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 执行同步钩子 并传参</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Compile</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><strong>MyPlugin.js</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const Compiler = require(&#x27;./compiler&#x27;);

class MyPlugin {
  // 接受 compiler 参数
  apply(compiler) {
    compiler.hooks.run.tap(&#x27;MyPlugin&#x27;, () =&gt; console.log(&#x27;开始编译...&#x27;));
    compiler.hooks.compiler.tapAsync(&#x27;MyPlugin&#x27;, (name, age) =&gt; {
      setTimeout(() =&gt; {
        console.log(&#x27;编译中&#x27;);
      }, 1000);
    });
  }
}

// 这里类似于 webpack.config.js 的 Plugins 配置
// 向 Plugins 属性传入 new 实例

const myPlugin = new MyPlugin();

const options = {
  plugins: [myPlugin],
};

let compiler = new Compiler(options);
compiler.run();
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Compiler</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./compiler&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">MyPlugin</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 接受 compiler 参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">run</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span><span class="token string">&#x27;MyPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;开始编译...&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">compiler</span><span class="token punctuation">.</span><span class="token method function property-access">tapAsync</span><span class="token punctuation">(</span><span class="token string">&#x27;MyPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token parameter punctuation">,</span><span class="token parameter"> age</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;编译中&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 这里类似于 webpack.config.js 的 Plugins 配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 向 Plugins 属性传入 new 实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> myPlugin </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">MyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> options </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">myPlugin</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> compiler </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Compiler</span><span class="token punctuation">(</span><span class="token plain">options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="理解-compiler-负责编译"><a aria-hidden="true" href="#理解-compiler-负责编译"><span class="icon icon-link"></span></a>理解 Compiler 负责编译</h2><p>开发插件首先要知道 <code>compiler</code> 和 <code>compilation</code> 对象是做什么的。</p><p><code>Compiler</code> 对象包含了当前运行 Webpack 的配置，包括 <code>entry</code>、<code>output</code>、<code>loader</code> 等配置，这个对象在启动 Webpack 时被实例化，而且是全局唯一的。<code>Plugin</code> 可以通过该对象获取到 Webpack 的配置信息进行处理。</p><p>如果看完这段话，你还是没理解 <code>compiler</code> 是做啥的，不要怕。运行 <code>npm run build</code>，把 <code>compiler</code> 的全部信息输出到控制台上 <code>console.log(compiler)</code>。</p></div><img alt="Compiler对象实例" src="/webpack-guidebook/static/console-compiler.6ef45e6f.png" width="720"/><div class="markdown"><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="Compiler {
  _pluginCompat: SyncBailHook {},
  hooks: {
    shouldEmit: SyncBailHook {
      // ...
    },
    done: AsyncSeriesHook {
      // ...
    },
    additionalPass: AsyncSerirsHook {
      // ...
    },
    beforeRun: AsyncSeriesHook {
      // ...
    },
    run: AsyncSeriesHook {
      // ...
    },
    emit: AsyncSeriesHook {
      // ...
    },
    assetEmitted: AsyncSeriesHook {
      // ...
    },
    afterEmit: AsyncSeriesHook {
      // ...
    },
    thisCompilation: SyncHook {
      // ...
    },
    compilation: SyncHook {
      // ...
    },
    normalModuleFactory: SyncHook {
      // ...
    },
    contextModuleFacotry: SyncHook {
      // ...
    },
    beforeCompile: AsyncSeriesHook {
      // ...
    },
    compile: SyncHook {
      // ...
    },
    make: AsyncParallelHook {
      // ...
    },
    afterCompile: AsyncSeriesHook {
      // ...
    },
    watchRun: AsyncSeriesHook {
      // ...
    },
    failed: SyncHook {
      // ...
    },
    invalid: SyncHook {
      // ...
    },
    watchClose: SyncHook {
      // ...
    },
    infrastructureLog: SyncBailHook {
      // ...
    },
    environment: SyncHook {
      // ...
    },
    afterEnvironment: SyncHook {
      // ...
    },
    afterPlugins: SyncHook {
      // ...
    },
    afterResolvers: SyncHook {
      // ...
    },
    entryOption: SyncBailHook {
      // ...
    },
    infrastructurelog: SyncBailHook {
      // ...
    }
  },
  outputPath: &#x27;&#x27;, // 输出目录
  outputFileSystem: NodeOutputFileSystem {
    // ...
  },
  inputFileSystem: CachedInputFileSystem {
    // ...
  },
  options: {
    // Compiler 对象包含了 Webpack 的所有配置信息，entry、module、output、resolve 等信息
    entry: [
      &#x27;babel-polyfill&#x27;,
      &#x27;/Users/mrsingsing/Webpack-Guidebook/example/demo/src/index.js&#x27;
    ],
    devServer: {
      port: 3000
    },
    output: {
      // ...
    },
    module: {
      // ...
    },
    plugins: [ MyWebpackPlugin {} ],
    mode: &#x27;production&#x27;,
    context: &#x27;/Users/mrsingsing/Webpack-Guidebook/example/demo/src/webpack-plugin&#x27;,
    devtool: false,
    performance: {
      maxAssetSize: 250000,
      maxEntrypointSize: 250000,
      hints: &#x27;warning&#x27;,
    },
    optimization: {
      // ...
    },
    resolve: {
      // ...
    },
    resolveLoader: {
      // ...
    },
    infrastructureLogging: {
      level: &#x27;info&#x27;,
      debug: false,
    }
  },
  context: &#x27;/Users/mrsingsing/Webpack-Guidebook/example/demo/src/webpack-plugin&#x27;, // 上下文，文件目录
  requestShortener: RequestShortener {
    // ...
  },
  watchFileSystem: NodeWatchFileSystem {
    // 监听文件变化列表信息
  }
}
" data-status="copy"></button><div class="token-line"><span class="token maybe-class-name">Compiler</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _pluginCompat</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncBailHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  hooks</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    shouldEmit</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncBailHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    done</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    additionalPass</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSerirsHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    beforeRun</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    emit</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    assetEmitted</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    afterEmit</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    thisCompilation</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    compilation</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    normalModuleFactory</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    contextModuleFacotry</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    beforeCompile</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    compile</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    make</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncParallelHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    afterCompile</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    watchRun</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    failed</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    invalid</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    watchClose</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    infrastructureLog</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncBailHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    environment</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    afterEnvironment</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    afterPlugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    afterResolvers</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    entryOption</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncBailHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    infrastructurelog</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SyncBailHook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  outputPath</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 输出目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  outputFileSystem</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">NodeOutputFileSystem</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  inputFileSystem</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">CachedInputFileSystem</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  options</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// Compiler 对象包含了 Webpack 的所有配置信息，entry、module、output、resolve 等信息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    entry</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&#x27;babel-polyfill&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&#x27;/Users/mrsingsing/Webpack-Guidebook/example/demo/src/index.js&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    devServer</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      port</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">3000</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    output</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    module</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    plugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token maybe-class-name">MyWebpackPlugin</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    mode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;production&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    context</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;/Users/mrsingsing/Webpack-Guidebook/example/demo/src/webpack-plugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    devtool</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token dom variable">performance</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      maxAssetSize</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">250000</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      maxEntrypointSize</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">250000</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      hints</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;warning&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    optimization</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    resolve</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    resolveLoader</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    infrastructureLogging</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      level</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;info&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      debug</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  context</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;/Users/mrsingsing/Webpack-Guidebook/example/demo/src/webpack-plugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 上下文，文件目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  requestShortener</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">RequestShortener</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  watchFileSystem</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">NodeWatchFileSystem</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 监听文件变化列表信息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>Compiler 源码精简版代码解析</p><p><a href="https://github.com/webpack/webpack/blob/master/lib/Compiler.js" target="_blank" rel="noopener noreferrer">源码地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const { SyncHook, SyncBailHook, AsyncSeriesHook } = require(&#x27;tapable&#x27;);

class Compiler {
  constructor() {
    // 1. 定义生命周期钩子
    this.hooks = Object.freeze({
      // ...只列举几个常用的常见钩子，更多 Hook 就不列举了，有兴趣看源码
      done: new AsyncSeriesHook([&#x27;stats&#x27;]), // 一次编译完成后执行，回调参数：stats
      beforeRun: new AsyncSeriesHook([&#x27;compiler&#x27;]),
      run: new AsyncSeriesHook([&#x27;compiler&#x27;]), // 在编译器开始读取记录前执行
      emit: new AsyncSeriesHook([&#x27;compilation&#x27;]), // 在生成文件到 output 目录之前执行，回调参数：compilation
      afterEmit: new AsyncSeriesHook([&#x27;compilation&#x27;]), // 在生成文件到 output 目录之后执行
      compilation: new SyncHook([&#x27;compilation&#x27;, &#x27;params&#x27;]), // 在一次 compilation 创建后执行执行插件
      beforeCompile: new AsyncSeriesHook([&#x27;params&#x27;]),
      compile: new SyncHook([&#x27;params&#x27;]), // 在一个新的 compilation 创建之前执行
      make: new AsyncParallelHook([&#x27;compilation&#x27;]), // 完成一次编译之前执行
      afterCompile: new AsyncSeriesHook([&#x27;compilation&#x27;]),
      watchRun: new AsyncSeriesHook([&#x27;compiler&#x27;]),
      failed: new SyncHook([&#x27;error&#x27;]),
      watchClose: new SyncHook([]),
      afterPlugins: new SyncHook([&#x27;compiler&#x27;]),
      entryOption: new SyncBailHook([&#x27;context&#x27;, &#x27;entry&#x27;]),
    });
  }
  newCompilation() {
    // 创建 Compilation 对象回调 compilation 相关钩子
    const compilation = new Compilation(this);

    // 省略

    this.hooks.compilation.call(compilation, params); // compilation 对象创建完成
    return compilation;
  }
  watch() {
    // 如果运行在 watch 模式则执行 watch 方法，否则执行 run 方法
    if (this.running) {
      return handler(new ConcurrentCompilationError());
    }
    this.running = true;
    this.watchMode = true;
    return new Watching(this, watchOptions, handler);
  }
  run(callback) {
    if (this.running) {
      return callback(new ConcurrentCompilationError());
    }
    this.running = true;
    process.nextTick(() =&gt; {
      this.emitAssets(compilation, err =&gt; {
        if (err) {
          // 在编译和输出的流程中遇到异常时，会触发 failed 事件
          this.hooks.failed.call(err);
        }
        if (compilation.hooks.needAdditionalPass.call()) {
          // ...
          // done 完成编译
          this.hooks.done.callAsync(stats, err =&gt; {
            // 创建 compilation 对象之前
            this.compile(onCompiled);
          });
        }
        this.emitRecords(err =&gt; {
          this.hooks.done.callAsync(stats, err =&gt; {
            // ...
          });
        });
      });
    });

    this.hooks.beforeRun.callAsync(this, err =&gt; {
      this.hooks.run.callAsync(this, err =&gt; {
        this.readRecords(err =&gt; {
          this.compile(onCompiled);
        });
      });
    });
  }
  compile(callback) {
    const params = this.newCompilationParams();
    this.hooks.beforeCompile.callAsync(params, err =&gt; {
      this.hooks.beforeCompile.call(params);
      const compilation = this.newCompilation(params);
      // 触发 make 事件并调用 addEntry，找到入口 JS，进行下一步
      this.hooks.make.callAsync(compilation, err =&gt; {
        process.nextTick(() =&gt; {
          compilation.finish(err =&gt; {
            // 封装构建结果（seal），逐次对每个 module 和 chunk 进行整理，每个 chunk 对应一个入口文件
            compilation.seal(err =&gt; {
              this.hooks.afterCompile.callAsync(compilation, err =&gt; {
                // 异步的事件需要在插件处理完成任务时调用回调函数通知 Webpack 进入下一个流程
                // 不然运行流程将会一直佧在这不往下执行
                return callback(null, compilation);
              });
            });
          });
        });
      });
    });
  }
  emitAssets(compilation, callback) {
    const emitFiles = err =&gt; {
      // ...省略
      // afterEmit：文件已经写入磁盘完成
      this.hooks.afterEmit.callAsync(compilation, err =&gt; {
        if (err) return callback(err);
        return callback();
      });
    };

    // emit 事件发生时，可以读取到最终输出的资源、代码块、模块及其依赖，并进行修改（这是最后一次修改最终文件的机会）
    this.hooks.emit.callAsync(compilation, err =&gt; {
      if (err) return callback(err);
      outputPath = compilation.getPath(this.outputPath, {});
      mkdirp(this.outputFileSystem, outputPath, emitFiles);
    });
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">SyncHook</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">SyncBailHook</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncSeriesHook</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;tapable&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Compiler</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 1. 定义生命周期钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...只列举几个常用的常见钩子，更多 Hook 就不列举了，有兴趣看源码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      done</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;stats&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 一次编译完成后执行，回调参数：stats</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      beforeRun</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compiler&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compiler&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 在编译器开始读取记录前执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      emit</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compilation&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 在生成文件到 output 目录之前执行，回调参数：compilation</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      afterEmit</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compilation&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 在生成文件到 output 目录之后执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      compilation</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compilation&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;params&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 在一次 compilation 创建后执行执行插件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      beforeCompile</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;params&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      compile</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;params&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 在一个新的 compilation 创建之前执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      make</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compilation&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 完成一次编译之前执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      afterCompile</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compilation&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      watchRun</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compiler&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      failed</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      watchClose</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      afterPlugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;compiler&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      entryOption</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;context&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;entry&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">newCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 创建 Compilation 对象回调 compilation 相关钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> compilation </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Compilation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 省略</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token method function property-access">compilation</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">compilation</span><span class="token punctuation">,</span><span class="token plain"> params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// compilation 对象创建完成</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> compilation</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果运行在 watch 模式则执行 watch 方法，否则执行 run 方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">running</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentCompilationError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">running</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">watchMode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Watching</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> watchOptions</span><span class="token punctuation">,</span><span class="token plain"> handler</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">running</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentCompilationError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">running</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    process</span><span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emitAssets</span><span class="token punctuation">(</span><span class="token plain">compilation</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 在编译和输出的流程中遇到异常时，会触发 failed 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token method function property-access">failed</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">compilation</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token method function property-access">needAdditionalPass</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// done 完成编译</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">done</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token plain">stats</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 创建 compilation 对象之前</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token plain">onCompiled</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emitRecords</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">done</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token plain">stats</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">beforeRun</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">run</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">readRecords</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token plain">onCompiled</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> params </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">beforeCompile</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token plain">params</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token method function property-access">beforeCompile</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> compilation </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">newCompilation</span><span class="token punctuation">(</span><span class="token plain">params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 触发 make 事件并调用 addEntry，找到入口 JS，进行下一步</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">make</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token plain">compilation</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        process</span><span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          compilation</span><span class="token punctuation">.</span><span class="token method function property-access">finish</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 封装构建结果（seal），逐次对每个 module 和 chunk 进行整理，每个 chunk 对应一个入口文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            compilation</span><span class="token punctuation">.</span><span class="token method function property-access">seal</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">afterCompile</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token plain">compilation</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token comment">// 异步的事件需要在插件处理完成任务时调用回调函数通知 Webpack 进入下一个流程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token comment">// 不然运行流程将会一直佧在这不往下执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> compilation</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">emitAssets</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">emitFiles</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...省略</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// afterEmit：文件已经写入磁盘完成</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">afterEmit</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token plain">compilation</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// emit 事件发生时，可以读取到最终输出的资源、代码块、模块及其依赖，并进行修改（这是最后一次修改最终文件的机会）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">emit</span><span class="token punctuation">.</span><span class="token method function property-access">callAsync</span><span class="token punctuation">(</span><span class="token plain">compilation</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      outputPath </span><span class="token operator">=</span><span class="token plain"> compilation</span><span class="token punctuation">.</span><span class="token method function property-access">getPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">outputPath</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">mkdirp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">outputFileSystem</span><span class="token punctuation">,</span><span class="token plain"> outputPath</span><span class="token punctuation">,</span><span class="token plain"> emitFiles</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>apply</code> 方法中插入钩子的一般形式如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// compiler 提供了 compiler.hooks，可以根据这些不同的时刻去让插件做不同的事情
compiler.hooks.阶段.tap函数(&#x27;插件名称&#x27;, 阶段回调参数 =&gt; {
  // do something
});

compiler.run(callback);
" data-status="copy"></button><div class="token-line"><span class="token comment">// compiler 提供了 compiler.hooks，可以根据这些不同的时刻去让插件做不同的事情</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">阶段</span><span class="token punctuation">.</span><span class="token method function property-access">tap函数</span><span class="token punctuation">(</span><span class="token string">&#x27;插件名称&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">阶段回调参数</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// do something</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token plain">callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="理解-compilation-负责创建-bundle"><a aria-hidden="true" href="#理解-compilation-负责创建-bundle"><span class="icon icon-link"></span></a>理解 Compilation 负责创建 bundle</h2><p>Compilation 对象代表了一次资源版本构建。当运行 Webpack 开发环境中间件时，每当检测到一个文件变化，就会创建新的 <code>compilation</code>，从而生成一组新的编译资源。一个 <code>Compilation</code> 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息，简单来讲就是把本次打包编译的内容存到内存里。Compilation 对象也提供了插件需要自定义功能的回调，以供插件做自定义处理时选择使用拓展。</p><p>简单来说，Compilation 的职责就是构建模块和 Chunk，并利用插件优化构建过程。</p><p>和 Compiler 用法相同，钩子类型不同，也可以在某些钩子上访问 <code>tapAsync</code> 和 <code>tapPromise</code>。</p><p>控制台输出 <code>console.log(compilation)</code>：</p></div><img alt="Compilation" src="/webpack-guidebook/static/console-compilation.8d98d6bd.png" width="720"/><div class="markdown"><p>通过 Compilation 也能读取到 Compiler 对象。</p><p>常用 Compilation Hooks：</p><table><thead><tr><th>钩子</th><th>类型</th><th>调用时机</th></tr></thead><tbody><tr><td>buildModule</td><td>SyncHook</td><td>在模块开始编译之前触发，可以用于修改模块</td></tr><tr><td>succeedModule</td><td>SyncHook</td><td>当一个模块被成功编译，会执行这个钩子</td></tr><tr><td>finishModules</td><td>AsyncSeriesHook</td><td>当所有模块都编译成功后被调用</td></tr><tr><td>seal</td><td>SyncHook</td><td>当一次 <code>compilation</code> 停止接收新模块时触发</td></tr><tr><td>optimizeDependencies</td><td>SyncBailHook</td><td>在依赖优化的开始执行</td></tr><tr><td>optimize</td><td>SyncHook</td><td>在优化阶段的开始执行</td></tr><tr><td>optimizeModules</td><td>SyncBailHook</td><td>在模块优化阶段开始时执行，插件可以在这个钩子里执行对模块的优化，回调参数：<code>modules</code></td></tr><tr><td>optimizeChunks</td><td>SyncBailHook</td><td>在代码块优化阶段开始时执行，插件可以在这个钩子里执行对代码块的优化，回调参数：<code>chunks</code></td></tr><tr><td>optimizeChunkAssets</td><td>AsyncSeriesHook</td><td>优化任何代码块资源，这些资源存放在 <code>compilation.assets</code> 上。一个 Chunk 有一个 files 属性</td></tr><tr><td>optimizeAssets</td><td>AsyncSeriesHook</td><td>优化所有存放在 <code>compilation.assets</code> 的所有资源。回调参数：<code>assets</code></td></tr></tbody></table><h2 id="compiler-和-compilation-的区别"><a aria-hidden="true" href="#compiler-和-compilation-的区别"><span class="icon icon-link"></span></a>Compiler 和 Compilation 的区别</h2><p>Compiler 代表了整个 Webpack 从启动到关闭的生命周期，而 Compilation 只是代表了一次新的编译，只要文件有改动，<code>compilation</code> 就会被重新创建。</p><h2 id="常用-api"><a aria-hidden="true" href="#常用-api"><span class="icon icon-link"></span></a>常用 API</h2><p>插件可以用来修改输出文件、增加输出文件、甚至可以提升 Webpack 性能等等，总之插件通过调用 Webpack 提供的 API 能完成很多事情。由于 Webpack 提供的 API 非常多，有很多 API 很少用得上，又加上篇幅有限，下面介绍常用的 API。</p><h3 id="读取输出资源、代码块、模块及其依赖"><a aria-hidden="true" href="#读取输出资源、代码块、模块及其依赖"><span class="icon icon-link"></span></a>读取输出资源、代码块、模块及其依赖</h3><p>有些插件可能需要读取 Webpack 的处理结果，例如输出资源、代码块、模块及其依赖，以便做下一步处理。在 emit 事件发生时，代表源文件的转换和组装已经完成，在这里可以读取到最终将输出的资源、代码块、模块及其依赖，并且可以修改输出资源的内容。插件代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="class Plugin {
  apply(compiler) {
    comiler.plugin(&#x27;emit&#x27;, function(compilation, callback) {
      // compilation.chunks 存放所有代码块，是一个数组
      compilation.chunks.forEach(function (chunk) {
        // chunk 代表一个代码块
        // 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块
        chunk.forEachModule(function(module) {
          // module 代表一个模块
          // module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组
          module.fileDependencies.forEach(function(filepath) {
            // ...
          })
        })

        // Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件
        // 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时
        // 该 Chunk 就会生成 .js 和 .css 两个文件
        chunk.files.forEach(function(filename) {
          // compilation.assets 存放当前所有即将输出的资源
          // 调用一个输出资源的 source() 方法能获取到输出资源的内容
          let source = compilation.assets.[filename].source()
        });
      });

      // 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束
      // 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行
      callback();
    })
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Plugin</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    comiler</span><span class="token punctuation">.</span><span class="token method function property-access">plugin</span><span class="token punctuation">(</span><span class="token string">&#x27;emit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// compilation.chunks 存放所有代码块，是一个数组</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      compilation</span><span class="token punctuation">.</span><span class="token property-access">chunks</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// chunk 代表一个代码块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        chunk</span><span class="token punctuation">.</span><span class="token method function property-access">forEachModule</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// module 代表一个模块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          module</span><span class="token punctuation">.</span><span class="token property-access">fileDependencies</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filepath</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 该 Chunk 就会生成 .js 和 .css 两个文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        chunk</span><span class="token punctuation">.</span><span class="token property-access">files</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// compilation.assets 存放当前所有即将输出的资源</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 调用一个输出资源的 source() 方法能获取到输出资源的内容</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> source </span><span class="token operator">=</span><span class="token plain"> compilation</span><span class="token punctuation">.</span><span class="token property-access">assets</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token plain">filename</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="监听文件变化"><a aria-hidden="true" href="#监听文件变化"><span class="icon icon-link"></span></a>监听文件变化</h3><p>Webpack 会从配置的入口模块触发，依次找出所有的依赖模块，当入口模块或者其依赖的模块发生变化时，就会触发依次新的 Compilation。</p><p>在开发插件时经常需要知道是哪个文件发生变化导致了新的 Compilation，为此可以使用如下代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 当依赖的文件发生变化时会触发 watch-run 事件
compiler.hooks.watchRun.tap(&#x27;MyPlugin&#x27;, (watching, callback) =&gt; {
  // 获取发生变化的文件列表
  const changedFiles = watching.compiler.watchFileSystem.watcher.mtimes;
  // changedFiles 格式为键值对，键为发生变化的文件路径
  if (changedFiles[filePath] !== undefined) {
    // filePath 对应的文件发生了变化
  }
  callback();
});
" data-status="copy"></button><div class="token-line"><span class="token comment">// 当依赖的文件发生变化时会触发 watch-run 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">watchRun</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span><span class="token string">&#x27;MyPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">watching</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 获取发生变化的文件列表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> changedFiles </span><span class="token operator">=</span><span class="token plain"> watching</span><span class="token punctuation">.</span><span class="token property-access">compiler</span><span class="token punctuation">.</span><span class="token property-access">watchFileSystem</span><span class="token punctuation">.</span><span class="token property-access">watcher</span><span class="token punctuation">.</span><span class="token property-access">mtimes</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// changedFiles 格式为键值对，键为发生变化的文件路径</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">changedFiles</span><span class="token punctuation">[</span><span class="token plain">filePath</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// filePath 对应的文件发生了变化</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>默认情况下 Webpack 只会监视入口和其他依赖的模块是否发生变化，在有些情况下项目可能需要引入新的文件，例如引入一个 HTML 文件。由于 JavaScript 文件不会去导入 HTML 文件，Webpack 就不会监听 HTML 文件的变化，编辑 HTML 文件时就不会重新触发新的 Compilation。为了监听 HTML 文件的变化，我们需要把 HTML 文件加入到依赖列表中，为此可以使用如下代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="compiler.hooks.afterCompile.tap(&#x27;MyPlugin&#x27;, (compilation, callback) =&gt; {
  // 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动依次编译
  compilation.fileDependencies.push(filePath);
  callback();
});
" data-status="copy"></button><div class="token-line"><span class="token plain">compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">afterCompile</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span><span class="token string">&#x27;MyPlugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动依次编译</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  compilation</span><span class="token punctuation">.</span><span class="token property-access">fileDependencies</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="修改输出资源"><a aria-hidden="true" href="#修改输出资源"><span class="icon icon-link"></span></a>修改输出资源</h3><p>有些场景下插件需要修改、增加、删除输出的资源，要做到这点需要监听 <code>emit</code> 事件，因为发生 <code>emit</code> 事件时所有模块的转换和代码块对应的文件已经生成好，需要输出的资源即将输出，因此 <code>emit</code> 事件是修改 Webpack 输出资源的最后时机。</p><p>所有需要输出的资源会存放在 <code>compilation.assets</code> 中，<code>compilation.assets</code> 是一个键值对，键为需要输出的文件名称，值为文件对应的内容。</p><p>设置 <code>compilation.assets</code> 的代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 设置名称为 fileName 的输出资源
compilation.assets[fileName] = {
  // 返回文件内容
  source: () =&gt; {
    // fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer
    return fileContent;
  },
  // 返回文件大小
  size: () =&gt; {
    return Buffer.byteLength(fileContent, &#x27;utf8&#x27;);
  },
};
" data-status="copy"></button><div class="token-line"><span class="token comment">// 设置名称为 fileName 的输出资源</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">compilation</span><span class="token punctuation">.</span><span class="token property-access">assets</span><span class="token punctuation">[</span><span class="token plain">fileName</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 返回文件内容</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">source</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> fileContent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 返回文件大小</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">size</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token method function property-access">byteLength</span><span class="token punctuation">(</span><span class="token plain">fileContent</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="判断-webpack-使用了哪些插件"><a aria-hidden="true" href="#判断-webpack-使用了哪些插件"><span class="icon icon-link"></span></a>判断 Webpack 使用了哪些插件</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 判断当前配置使用了 ExtractTextPlugin
// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数
function hasExtractTextPlugin(compiler) {
  // 当前配置所有使用的插件列表
  const plugins = compiler.options.plugins;
  // 去 plugins 中寻找有没有 ExtractTextPlugin 的实例
  return plugins.find(plugin =&gt; plugin.__proto__.constructor === ExtractTextPlugin) != null;
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// 判断当前配置使用了 ExtractTextPlugin</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">hasExtractTextPlugin</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 当前配置所有使用的插件列表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> plugins </span><span class="token operator">=</span><span class="token plain"> compiler</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">plugins</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 去 plugins 中寻找有没有 ExtractTextPlugin 的实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> plugins</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> plugin</span><span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span><span class="token property-access">constructor</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">ExtractTextPlugin</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="文件写入"><a aria-hidden="true" href="#文件写入"><span class="icon icon-link"></span></a>文件写入</h3><p>Compilation 上的 assets 可以用于文件写入</p><ul><li>可将 zip 资源包设置为 <code>compilation.assets</code> 对象上</li></ul><p>文件写入需要使用 <a href="https://www.npmjs.com/package/webpack-sources" target="_blank" rel="noopener noreferrer">webpack-sources<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const { RawSource } = require(&#x27;webpack-sources&#x27;);

module.exports = class DemoPlugin {
  constructor(options) {
    this.options = options;
  }

  apply(compiler) {
    const { name } = this.options;
    compilation.plugin(&#x27;emit&#x27;, (compilation, cb) =&gt; {
      compilation.assets[name] = new RawSource(&#x27;demo&#x27;);
      cb();
    });
  }
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">RawSource</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;webpack-sources&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">DemoPlugin</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> name </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    compilation</span><span class="token punctuation">.</span><span class="token method function property-access">plugin</span><span class="token punctuation">(</span><span class="token string">&#x27;emit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token parameter punctuation">,</span><span class="token parameter"> cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      compilation</span><span class="token punctuation">.</span><span class="token property-access">assets</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">RawSource</span><span class="token punctuation">(</span><span class="token string">&#x27;demo&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="异常或警告处理"><a aria-hidden="true" href="#异常或警告处理"><span class="icon icon-link"></span></a>异常或警告处理</h3><p>做一个实验，如果你在 <code>apply</code> 函数内插入 <code>throw new Error(&quot;message&quot;)</code>，终端会打印出 <code>Unhandled rejection Error: Message</code>。然后 Webpack 中断执行。为了不影响 Webpack 的执行，要在编译期间向用户发出警告或错误消息，则应使用 <code>compilation.warnings</code> 和 <code>compilation.errors</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="compilation.warnings.push(&#x27;warning&#x27;);

compilation.errors.push(&#x27;error&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token plain">compilation</span><span class="token punctuation">.</span><span class="token property-access">warnings</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">&#x27;warning&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">compilation</span><span class="token punctuation">.</span><span class="token property-access">errors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="插件扩展：编写插件的插件"><a aria-hidden="true" href="#插件扩展：编写插件的插件"><span class="icon icon-link"></span></a>插件扩展：编写插件的插件</h3><p>插件自身也可以通过暴露 hooks 的方式进行自身扩展，以 <code>html-webpack-plugin</code> 为例：</p><ul><li><code>html-webpack-plugin-alter-chunks</code>（Sync）</li><li><code>html-webpack-plugin-before-html-generation</code>（Async）</li><li><code>html-webpack-plugin-alter-asset-tags</code>（Async）</li><li><code>html-webpack-plugin-after-html-processing</code>（Async）</li><li><code>html-webpack-plugin-after-emit</code>（Async）</li></ul><h2 id="开发调试"><a aria-hidden="true" href="#开发调试"><span class="icon icon-link"></span></a>开发调试</h2><ol><li>在当前 Webpack 项目工程文件夹下面，执行命令行：</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="node --inspect-brk ./node_modules/webpack/bin/webpack.js --inline --progress
" data-status="copy"></button><div class="token-line"><span class="token plain">node --inspect-brk ./node_modules/webpack/bin/webpack.js --inline --progress</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>其中参数 <code>--inspect-brk</code> 就是以调试模式启动 Node：</p><p>终端会输出：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="Debugger listening on ws://127.0.0.1:9229/1018c03f-7473-4d60-b62c-949a6404c81d
For help, see: https://nodejs.org/en/docs/inspector
" data-status="copy"></button><div class="token-line"><span class="token plain">Debugger listening on ws://127.0.0.1:9229/1018c03f-7473-4d60-b62c-949a6404c81d</span></div><div class="token-line"><span class="token plain">For help, see: https://nodejs.org/en/docs/inspector</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="2"><li>Chrome 输入 <code>chrome://inspect/#devices</code></li></ol></div><img alt="浏览器调试模式" src="/webpack-guidebook/static/chrome-devices-inspect.5ddd130d.jpeg" width="640"/><div class="markdown"><ol start="3"><li>然后点击 Chrome 调试器中的 <code>继续执行</code>，断电就提留在我们设置在插件中的 bugger 断点了</li></ol></div><img alt="代码断点" src="/webpack-guidebook/static/chrome-debugger.e33a45ea.jpeg" width="640"/><div class="markdown"><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://juejin.im/post/5ec169786fb9a043721b46ad" target="_blank" rel="noopener noreferrer">📝 揭秘 Webpack 插件工作流程和原理（2020-05-18）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5ec16a2e5188256d841a53d0" target="_blank" rel="noopener noreferrer">📝 实现自定义 Webpack 插件详解（2020-05-19）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="http://wushaobin.top/2019/03/15/webpackPlugin/" target="_blank" rel="noopener noreferrer">📝 Webpack 学习 — Plugin（2019-03-15）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://zhuanlan.zhihu.com/p/26955349" target="_blank" rel="noopener noreferrer">📝 浅析 Webpack 插件化设计（2017-05-18）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/Webpack-Guidebook/edit/master/docs/principle-analysis/implementation-principle/plugin.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/18/2020, 10:19:07 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/webpack-guidebook/umi.js"></script>
    <script src="/webpack-guidebook/docs__principle-analysis__implementation-principle__plugin.md.js"></script>
  </body>
</html>
