<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/webpack-guidebook/umi.css" />
    <script>
      window.routerBase = "/webpack-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.20
    </script>
    <title>Loader 机制</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//">Webpack Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/webpack-guidebook//basic-summary">基本综述</a><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a><a href="/webpack-guidebook//best-practice">最佳实践</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//"></a><h1>Webpack Guidebook</h1><p>Webpack 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/webpack-guidebook//basic-summary">基本综述</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a></li><li><a href="/webpack-guidebook//best-practice">最佳实践</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/webpack-guidebook//principle-analysis/babel">Babel</a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle">工作原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/operational-principle/file-watch"><span>文件监听</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement"><span>模块热更新</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/filenames-hashes"><span>文件指纹策略</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking"><span>Tree Shaking</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting"><span>作用域提升</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/sourcemap"><span>SourceMap</span></a></li></ul></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/implementation-principle">底层原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/workflow"><span>构建流程</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/simple-implementation"><span>简易实现</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/source-code-analysis"><span>源码分析</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/tapable"><span>Tapable</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compiler"><span>Compiler</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compilation"><span>Compilation</span></a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/implementation-principle/loader"><span>Loader 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin"><span>Plugin 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/ast"><span>抽象语法树</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="使用方式" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#使用方式"><span>使用方式</span></a></li><li title="模块处理" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#模块处理"><span>模块处理</span></a></li><li title="原始数据" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#原始数据"><span>原始数据</span></a></li><li title="加载运行器" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#加载运行器"><span>加载运行器</span></a></li><li title="获取模块配置项" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#获取模块配置项"><span>获取模块配置项</span></a></li><li title="返回其他结果" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#返回其他结果"><span>返回其他结果</span></a></li><li title="同步与异步" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#同步与异步"><span>同步与异步</span></a></li><li title="处理二进制数据" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#处理二进制数据"><span>处理二进制数据</span></a></li><li title="文件输出" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#文件输出"><span>文件输出</span></a></li><li title="缓存加速" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#缓存加速"><span>缓存加速</span></a></li><li title="总体流程" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#总体流程"><span>总体流程</span></a></li><li title="区别" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader#区别"><span>区别</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="loader-机制"><a aria-hidden="true" href="#loader-机制"><span class="icon icon-link"></span></a>Loader 机制</h1><p>Loader 是 webpack 的核心概念之一，它的基本工作流是将一个文件以字符串的形式读入，对其进行语法分析及转换，然后交由下一环节进行处理，所有载入的模块最终都会经过 <code>moduleFactory</code> 处理，转成 JavaScript 可以识别和运行的代码，从而完成模块的集成。</p><h2 id="使用方式"><a aria-hidden="true" href="#使用方式"><span class="icon icon-link"></span></a>使用方式</h2><p>定义：Loader 只是一个导出为函数的 JavaScript 模块</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = function(source) {
  return source;
};
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> source</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>多 Loader 时的执行顺序</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = {
  module: {
    rules: [
      {
        test: /\.less$/,
        use: [&#x27;style-loader&#x27;, &#x27;css-loader&#x27;, &#x27;less-loader&#x27;],
      },
    ],
  },
};
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    rules</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        test</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token regex">/\.less$/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        use</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;style-loader&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;css-loader&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;less-loader&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>函数组合的两种情况：</p><ul><li>Unix 的 pipline</li><li>Compose（Webpack 采用）</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="compose = (f, g) =&gt; (...args) =&gt; f(g(...args));
" data-status="copy"></button><div class="token-line"><span class="token function-variable function">compose</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token parameter punctuation">,</span><span class="token parameter"> g</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter operator">...</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="模块处理"><a aria-hidden="true" href="#模块处理"><span class="icon icon-link"></span></a>模块处理</h2><h3 id="原始数据"><a aria-hidden="true" href="#原始数据"><span class="icon icon-link"></span></a>原始数据</h3><p>由于 Webpack 是运行在 Node.js 之上的，一个 Loader 其实就是一个 Node.js 模块，这个模块需要导出一个函数。这个导出的函数的工作就是获得处理前的元内容，对元内容的执行处理后，返回处理后的内容。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = function(source) {
  // source 为 compiler 传递给 Loader 的一个文件的原内容
  // 该函数需要返回处理后的内容给你，这里简单起见，直接把原内容返回了，相当于该 Loader 没有做任何转换
  return source;
};
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// source 为 compiler 传递给 Loader 的一个文件的原内容</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 该函数需要返回处理后的内容给你，这里简单起见，直接把原内容返回了，相当于该 Loader 没有做任何转换</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> source</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>由于 Loader 运行在 Node.js 中，可以调用任何 Node.js 中自带的 API，或者安装第三方模块进行调用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const sass = require(&#x27;node-sass&#x27;);

module.exports = function(source) {
  return sass(source);
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> sass </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;node-sass&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token plain">source</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="加载运行器"><a aria-hidden="true" href="#加载运行器"><span class="icon icon-link"></span></a>加载运行器</h3><p>定义：<code>loader-runner</code> 允许你不安装 Webpack 的情况下运行 loaders</p><p>作用：</p><ul><li>作为 Webpack 的依赖，Webpack 中使用它执行 loader</li><li>进行 loader 的开发和测试</li></ul><h3 id="获取模块配置项"><a aria-hidden="true" href="#获取模块配置项"><span class="icon icon-link"></span></a>获取模块配置项</h3><p>在 Loader 中获取用户传入的 <code>options</code>，通过 <code>loader-utils</code> 的 <code>getOptions</code> 方法获取：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const loaderUtils = require(&#x27;loader-utils&#x27;);

module.exports = function(source) {
  // 获取到用户句给当前 Loader 传入的 options
  const options = loaderUtils.getOptions(this);
  return source;
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> loaderUtils </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;loader-utils&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 获取到用户句给当前 Loader 传入的 options</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> options </span><span class="token operator">=</span><span class="token plain"> loaderUtils</span><span class="token punctuation">.</span><span class="token method function property-access">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> source</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="返回其他结果"><a aria-hidden="true" href="#返回其他结果"><span class="icon icon-link"></span></a>返回其他结果</h3><p>上面的 Loader 都只是返回了原内容转换后的内容，但有些场景下还需要返回除了内容之外的东西。</p><p>例如以用 babel-loader 转换 ES6 代码为例，它还需要输出转换后的 ES5 代码对应的 Source Map，以方便调试源码。</p><p>为了把 Source Map 也一起随着 ES5 代码返回给 Webpack，可以这样写：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = function(source) {
  // 通过 this.callback 告诉 Webpack 返回的结果
  this.callback(null, source, sourceMaps);
  // 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined
  // 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中
  return;
};
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 通过 this.callback 告诉 Webpack 返回的结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">callback</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> source</span><span class="token punctuation">,</span><span class="token plain"> sourceMaps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>其中 <code>this.callback</code> 是 Webpack 给 Loader 注入的 API，以方便 Loader 和 Webpack 之间通信。<code>this.callback</code> 的详细使用方法如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="this.callback(
  // 当无法转换原内容时，给 Webpack 返回一个 Error
  err: Error | null,
  // 原内容转换后的内容
  content: string | Buffer,
  // 用于把转换后的内容得出原内容的 SourceMap，方便调试
  sourceMap?: SourceMap,
  // 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回
  // 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能
  abstractSyntaxTree?: AST
)
" data-status="copy"></button><div class="token-line"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">callback</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 当无法转换原内容时，给 Webpack 返回一个 Error</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  err</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Error</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 原内容转换后的内容</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  content</span><span class="token punctuation">:</span><span class="token plain"> string </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用于把转换后的内容得出原内容的 SourceMap，方便调试</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  sourceMap</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">SourceMap</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  abstractSyntaxTree</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">AST</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><blockquote><p>Source Map 的生成很耗时，通常在开发环境下才会生成 Source Map，其他环境下不用生成，以加速构建。为此 Webpack 为 Loader 提供了 <code>this.sourceMap</code> API 去告诉 Loader 当前构建环境下用户是否需要 Source Map。如果你编写的 Loader 会生成 Source Map，请考虑到这点。</p></blockquote><h3 id="同步与异步"><a aria-hidden="true" href="#同步与异步"><span class="icon icon-link"></span></a>同步与异步</h3><p>Loader 有同步和异步之分，上面的 Loader 都是同步的 Loader，因为它们的转换流程都是同步的，转换完成后再返回结果。但有些场景下转换的步骤只能是异步完成的，例如你需要通过网络请求才能得出结果，如果采用同步的方式 <code>网络请求</code> 就会阻塞整个构建，导致构建非常缓慢。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = function(source) {
  // 告诉 Webpack 本次转换是异步的，Loader 会在 callback 中回调结果
  var callback = this.async();

  someAsyncOperation(source, function(err, result, sourceMaps, ast) {
    // 通过 callback 返回异步执行后的结果
    callback(err, result, sourceMaps, ast);
  });
};
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 告诉 Webpack 本次转换是异步的，Loader 会在 callback 中回调结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> callback </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token plain">source</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> result</span><span class="token parameter punctuation">,</span><span class="token parameter"> sourceMaps</span><span class="token parameter punctuation">,</span><span class="token parameter"> ast</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 通过 callback 返回异步执行后的结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">,</span><span class="token plain"> result</span><span class="token punctuation">,</span><span class="token plain"> sourceMaps</span><span class="token punctuation">,</span><span class="token plain"> ast</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="处理二进制数据"><a aria-hidden="true" href="#处理二进制数据"><span class="icon icon-link"></span></a>处理二进制数据</h3><p>在默认的情况下，Webpack 传给 Loader 的原内容都是 UTF-8 格式编码的字符串。但有些场景下 Loader 不是处理文本文件，而是处理二进制文件，例如 <code>file-loader</code>，就需要 Webpack 给 Loader 传入二进制格式的数据。为此，你需要这样编写 Loader：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = function(source) {
  // 在 exports.raw = true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的
  source instanceof Buffer === true;
  // Loader 返回的类型也可以是 Buffer 类型的
  // 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果
  return source;
};

// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据
module.exports.raw = true;
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 在 exports.raw = true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  source </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Buffer</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Loader 返回的类型也可以是 Buffer 类型的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> source</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">.</span><span class="token property-access">raw</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>以上代码中最关键的是最后一行 <code>module.exports.raw = true</code>，没有改行 Loader 只能拿到字符串。</p><h3 id="文件输出"><a aria-hidden="true" href="#文件输出"><span class="icon icon-link"></span></a>文件输出</h3><p>通过 <code>this.emitFile</code> 进行文件写入</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const loaderUtil = require(&#x27;loader-utils&#x27;);
module.exports = function(content) {
  const url = loaderUtil.interpolateName(this, &#x27;[hash].[ext]&#x27;, {
    content,
  });

  this.emitFile(url, content);

  const path = `__webpack_public_path__+${JSON.stringify(url)}`;

  return `export default ${path}`;
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> loaderUtil </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;loader-utils&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> url </span><span class="token operator">=</span><span class="token plain"> loaderUtil</span><span class="token punctuation">.</span><span class="token method function property-access">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;[hash].[ext]&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    content</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emitFile</span><span class="token punctuation">(</span><span class="token plain">url</span><span class="token punctuation">,</span><span class="token plain"> content</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">__webpack_public_path__+</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation constant">JSON</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation function">stringify</span><span class="token template-string interpolation punctuation">(</span><span class="token template-string interpolation">url</span><span class="token template-string interpolation punctuation">)</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">export default </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">path</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="缓存加速"><a aria-hidden="true" href="#缓存加速"><span class="icon icon-link"></span></a>缓存加速</h3><p>在有些情况下，有些转换操作需要大量计算非常耗时，如果每次构建都重新执行重复的转换操作，构建将会变得非常缓慢。为此，Webpack 会默认缓存所有 Loader 的处理结果，也就是说在需要被处理的文件或者其他依赖的文件没有发生变化时，是不会重新调用对应的 Loader 去执行转换操作的。</p><p>如果你想让 Webpack 不缓存该 Loader 的处理结果，可以这样：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = function(source) {
  // 关闭该 Loader 的缓存功能
  this.cacheable(false);
  return source;
};
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 关闭该 Loader 的缓存功能</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">cacheable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> source</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="总体流程"><a aria-hidden="true" href="#总体流程"><span class="icon icon-link"></span></a>总体流程</h2><p>Webpack 编译流程非常复杂，但其中设计 Loader 的部分主要包括：</p><ul><li>Loader（Webpack）的默认配置</li><li>使用 LoaderResolver 解析 Loader 模块路径</li><li>根据 <code>rule.modules</code> 创建 RulesSet 规则集</li><li>使用 loader-runner 运行 loader</li></ul><h2 id="区别"><a aria-hidden="true" href="#区别"><span class="icon icon-link"></span></a>区别</h2><blockquote><p>loader 和 plugin 有什么不同</p></blockquote><ul><li>Loader<ul><li>作用：让 Webpack 拥有加载和解析非 JavaScript 文件的能力，有独立的运行环境。</li><li>用法：<code>module.rules</code> 配置，作为模块的解析规则而存在。</li></ul></li><li>Plugin<ul><li>作用：能扩展 Webpack 的功能。在 Webpack 运行的生命周期中广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果。</li><li>用法：每项为实例，参数通过构造函数传入。</li></ul></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/Webpack-Guidebook/edit/master/docs/principle-analysis/implementation-principle/loader.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/18/2020, 10:19:07 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/webpack-guidebook/umi.js"></script>
    <script src="/webpack-guidebook/docs__principle-analysis__implementation-principle__loader.md.js"></script>
  </body>
</html>
