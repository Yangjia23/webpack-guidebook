<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/webpack-guidebook/umi.css" />
    <script>
      window.routerBase = "/webpack-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.20
    </script>
    <title>Tree Shaking</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//">Webpack Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/webpack-guidebook//basic-summary">基本综述</a><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a><a href="/webpack-guidebook//best-practice">最佳实践</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//"></a><h1>Webpack Guidebook</h1><p>Webpack 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/webpack-guidebook//basic-summary">基本综述</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a></li><li><a href="/webpack-guidebook//best-practice">最佳实践</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/webpack-guidebook//principle-analysis/babel">Babel</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/operational-principle">工作原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/operational-principle/file-watch"><span>文件监听</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement"><span>模块热更新</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/filenames-hashes"><span>文件指纹策略</span></a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking"><span>Tree Shaking</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting"><span>作用域提升</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/sourcemap"><span>SourceMap</span></a></li></ul></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle">底层原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/workflow"><span>构建流程</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/simple-implementation"><span>简易实现</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/source-code-analysis"><span>源码分析</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/tapable"><span>Tapable</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compiler"><span>Compiler</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compilation"><span>Compilation</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader"><span>Loader 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin"><span>Plugin 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/ast"><span>抽象语法树</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="使用方法" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#使用方法"><span>使用方法</span></a></li><li title="实现原理" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#实现原理"><span>实现原理</span></a></li><li title="DCE" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#dce"><span>DCE</span></a></li><li title="无用模块消除" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#无用模块消除"><span>无用模块消除</span></a></li><li title="实现细节" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#实现细节"><span>实现细节</span></a></li><li title="实例分析" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#实例分析"><span>实例分析</span></a></li><li title="函数处理" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#函数处理"><span>函数处理</span></a></li><li title="类的处理" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#类的处理"><span>类的处理</span></a></li><li title="副作用" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#副作用"><span>副作用</span></a></li><li title="模块引入带来的副作用" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#模块引入带来的副作用"><span>模块引入带来的副作用</span></a></li><li title="方法调用带来的副作用" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#方法调用带来的副作用"><span>方法调用带来的副作用</span></a></li><li title="如何解决副作用" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#如何解决副作用"><span>如何解决副作用</span></a></li><li title="最佳实践" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#最佳实践"><span>最佳实践</span></a></li><li title="合理模块设计" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#合理模块设计"><span>合理模块设计</span></a></li><li title="实用建议" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking#实用建议"><span>实用建议</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="tree-shaking"><a aria-hidden="true" href="#tree-shaking"><span class="icon icon-link"></span></a>Tree Shaking</h1><p><strong>TreeShaking</strong> 是 DCE（Dead Code Elimination）的实现，该功能让代码文件中没有使用过的代码片段能在构建过程中删除，从而达到构建产物的优化。</p><p>引用 TreeShaking 提出者也是 Rollup 作者的比喻：</p><blockquote><p>如果把代码打包比作制作蛋糕。传统的方式是把鸡蛋（带壳）全部丢进去搅拌，然后放入烤箱，最后把（没有用的）蛋壳全部挑选并剔除出去。而 TreeShaking 则是一开始就把有用的蛋白蛋黄放入搅拌，最后直接作出蛋糕。</p></blockquote><p>基于 ES6 的静态引用，TreeShaking 通过扫描所有 ES6 的 <code>export</code>，找出被 <code>import</code> 的内容并添加到最终代码中。</p><p>Webpack 的实现是把所有 <code>import</code> 标记为 <strong>有使用</strong> / <strong>无使用</strong> 两种，在后续压缩时进行区别处理。因为就如比喻所说，在放入烤箱（压缩混淆）前先剔除蛋壳（无使用的 <code>import</code>），只放入有用的蛋白蛋黄（有使用的 <code>import</code>）。</p><h2 id="使用方法"><a aria-hidden="true" href="#使用方法"><span class="icon icon-link"></span></a>使用方法</h2><p>首先源码必须遵循 ES6 的模块规范（<code>import</code> &amp; <code>export</code>），如果是 CommonJS 规范（<code>require</code>）则无法使用。</p><p>根据 Webpack 官网的提示，Webpack2 支持 TreeShaking，需要修改配置文件，指定 Babel 处理 JavaScript 文件时不要将 ES6 模块转成 CommonJS 模块，具体做法就是：</p><p>在 <code>.babelrc</code> 设置 <code>babel-preset-es2015</code> 的 <code>modules</code> 为 <code>fasle</code>，<strong>表示不对 ES6 模块进行处理</strong>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-json"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// .babelrc
{
  &quot;presets&quot;: [[&quot;es2015&quot;, { &quot;modules&quot;: false }]]
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// .babelrc</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token property">&quot;presets&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;es2015&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token property">&quot;modules&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>或者在 Webpack 的 babel-loader 中设置</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        use: {
          loader: &#x27;babel-loader&#x27;,
          options: {
            presets: [&#x27;]
          }
        }
      }
    ]
  }
}
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    rules</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        test</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        use</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          loader</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;babel-loader&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          options</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            presets</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">&#x27;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>经过测试，Webpack 3 和 4 不增加这个 <code>.babelrc</code> 文件也可以正常 TreeShaking。</p><h2 id="实现原理"><a aria-hidden="true" href="#实现原理"><span class="icon icon-link"></span></a>实现原理</h2><h3 id="dce"><a aria-hidden="true" href="#dce"><span class="icon icon-link"></span></a>DCE</h3><p>TreeShaking 的本质是消除无用的 JS 代码。无用代码消除在广泛存在于传统的编程语言编译器中，编译器可以判断出某些代码根本不影响输出，然后消除这些代码，这个称之为 <strong>DCE</strong>（dead code elimination）。</p><p>TreeShaking 是 DCE 的一种新的实现，JavaScript 同传统的编程语言不同的是，JavaScript 绝大多数情况需要通过网络进行加载，然后执行，加载的文件大小越小，整体执行时间更短，所以去除无用代码以减少文件体积，对 JavaScript 来说更有意义。</p><p>TreeShaking 和传统的 DCE 的方法又不太一样，传统的 DCE <strong>消灭不可能执行的代码</strong>，而 TreeShaking 更关注于 <strong>消除没有用到的代码</strong>。</p><h3 id="无用模块消除"><a aria-hidden="true" href="#无用模块消除"><span class="icon icon-link"></span></a>无用模块消除</h3><p>前面提到了 TreeShaking 更关注于无用模块的消除，消除那些引用了但并没有被使用的模块。</p><blockquote><p>为什么只用 ES6 Module 才能使用 TreeShaking？</p></blockquote><p>我们先来谈谈 ES6 Module 的特点：</p><ul><li>只能作为模块顶层的语句出现</li><li><code>import</code> 的模块名只能是字符串常量</li><li>import binding 是 immutable 的</li></ul><p>ES6 模块依赖关系是确定的，和运行时的状态无关，可以进行可靠的静态分析，故而可以在编译时正确判断到底加载了什么代码，分析程序流，判断哪些变量未被使用、引用，进而删除无用代码，这就是 TreeShaking 的基础。</p><p>所谓 <strong>静态分析</strong> 就是不执行代码，从字面量上对代码进行分析，ES6 之前的模块化，比如我们可以动态 <code>require</code> 一个模块，只有执行后才知道引用的什么模块，这个就不能通过静态分析去做优化。</p><p>这是 ES6 Modules 在设计时的一个重要考量，也是为什么没有直接采用 CommonJS，正是基于这个基础上，才使得 TreeShaking 成为可能，这也是为什么 Rollup 和 Webpack2 都要用 ES6 Module Syntax 才能 TreeShaking。</p><h3 id="实现细节"><a aria-hidden="true" href="#实现细节"><span class="icon icon-link"></span></a>实现细节</h3><p>Webpack 负责对代码进行标记，把 <code>import</code> &amp; <code>export</code> 标记为三类：</p><ol><li>所有 <code>import</code> 标记为 <code>/* harmony import */</code></li><li>被使用过的 <code>export</code> 标记为 <code>/* harmony export ([type]) */</code>，其中 <code>[type]</code> 和 Webpack 内部有关，可能是 <code>binding</code>、<code>immutable</code> 等等。</li><li>没被使用过的 <code>export</code> 标记为 <code>/* unused harmony export [FuncName] */</code>，其中 <code>[FuncName]</code> 为 <code>export</code> 的方法名称</li></ol><p>之后在 Uglifyjs (或者其他类似的工具) 步骤进行代码精简，把没用的都删除。</p><h2 id="实例分析"><a aria-hidden="true" href="#实例分析"><span class="icon icon-link"></span></a>实例分析</h2><h3 id="函数处理"><a aria-hidden="true" href="#函数处理"><span class="icon icon-link"></span></a>函数处理</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import { foo, bar } from &#x27;./utils&#x27;;

const result = foo();

console.log(result);
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> foo</span><span class="token punctuation">,</span><span class="token plain"> bar </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./utils&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// utils.js
export function foo() {
  return &#x27;foo&#x27;;
}

export function bar() {
  return &#x27;bar&#x27;;
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// utils.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;foo&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;bar&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>对于没有被使用的 <code>bar</code> 方法，Webpack 标记其为 <code>unused harmony export bar</code>，但是代码依旧保留。而 <code>foo</code> 就是正常的 <code>harmony export (immutable)</code>。</p><p>之后使用 <code>UglifyJSPlugin</code> 就可以进行第二步，把 <code>bar</code> 彻底清除。</p><h3 id="类的处理"><a aria-hidden="true" href="#类的处理"><span class="icon icon-link"></span></a>类的处理</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import Utils from &#x27;./utils&#x27;;

const utils = new Utils();
const result = util.foo();

console.log(result);
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token maybe-class-name">Utils</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./utils&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> utils </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Utils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> util</span><span class="token punctuation">.</span><span class="token method function property-access">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// utils.js
export default class Util {
  foo() {
    return &#x27;foo&#x27;;
  }
  bar() {
    return &#x27;bar&#x27;;
  }
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// utils.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Util</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;foo&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;bar&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>注意到 Webpack 是对 Util 类整体进行标记的（标记为被使用），而不是分别针对两个方法。也因此，最终打包的代码依然会包含 <code>bar</code> 方法。这表明 Webpack TreeShaking 只处理顶层内容，例如类和对象内部都不会再被分别处理。</p><p>这主要也是由于 JS 的动态语言特性所致。如果把 <code>bar</code> 删除，考虑如下代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import Utils from &#x27;./utils&#x27;;

const utils = new Utils();
const result = util[Math.random() &gt; 0.5 ? &#x27;foo&#x27; : &#x27;bar&#x27;]();

console.log(result);
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token maybe-class-name">Utils</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./utils&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> utils </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Utils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> util</span><span class="token punctuation">[</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0.5</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token string">&#x27;foo&#x27;</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;bar&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>编译器并不能识别一个方法名字究竟是以直接调用的形式出现（<code>utils.foo()</code>）还是以字符串的形式（<code>utils[&#x27;foo&#x27;]</code>）或者其他更加离奇的方式。因此误删方法只会导致运行出错，得不偿失。</p><h2 id="副作用"><a aria-hidden="true" href="#副作用"><span class="icon icon-link"></span></a>副作用</h2><p>副作用的意思某个方法或者文件执行了之后，还会对全局其他内容产生影响的代码。例如 polyfill 在各类 <code>prototype</code> 加入方法，就是副作用的典型。</p><p>副作用总共有两种形态，是精简代码不得不考虑的问题。我们平时在重构代码时，也应当以相类似的思维去进行，否则总有踩坑的一天。</p><h3 id="模块引入带来的副作用"><a aria-hidden="true" href="#模块引入带来的副作用"><span class="icon icon-link"></span></a>模块引入带来的副作用</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import Utils from &#x27;./utils&#x27;;

console.log(&#x27;Util is unused.&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token maybe-class-name">Utils</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./utils&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Util is unused.&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// utils.js
console.log(&#x27;This is utils.js&#x27;);

export default class Utils {
  foo() {
    return &#x27;foo&#x27;;
  }
  bar() {
    return &#x27;bar&#x27;;
  }
}

Array.prototype.foo = () =&gt; &#x27;foo&#x27;;
" data-status="copy"></button><div class="token-line"><span class="token comment">// utils.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;This is utils.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Utils</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;foo&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;bar&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">foo</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token string">&#x27;foo&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>虽然 Util 类被引入之后没有进行任何使用，但是不能当做没引用过而直接删除。在混合后的代码中，可以看到 Utils 类的本体 (<code>export</code> 的内容) 已经没有了，但是前后的 <code>console.log</code> 和对 <code>Array.prototype</code> 的扩展依然保留。这就是编译器为了确保代码执行效果不变而做的妥协，因为它不知道这两句代码到底是干嘛的，所以他默认认定所有代码 均有 副作用。</p><h3 id="方法调用带来的副作用"><a aria-hidden="true" href="#方法调用带来的副作用"><span class="icon icon-link"></span></a>方法调用带来的副作用</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import { foo, bar } from &#x27;./utils&#x27;;

const result1 = foo();
const result2 = bar();

console.log(result1);
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> foo</span><span class="token punctuation">,</span><span class="token plain"> bar </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./utils&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// utils.js
export function foo() {
  return &#x27;foo&#x27;;
}

export function bar() {
  return &#x27;bar&#x27;;
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// utils.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;foo&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;bar&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>我们引入并调用了 <code>bar()</code>，但是却没有使用它的返回值 <code>result2</code>，这种代码可以删吗？</p><p>Webpack 并没有删除这行代码，至少没有删除全部。它确实删除了 <code>result2</code>，但保留了 <code>bar()</code> 的调用（压缩的代码表现为 <code>Object(r.a)()</code>）以及 <code>bar()</code> 的定义。</p><p>这同样是因为编译器不清楚 <code>bar()</code> 里面究竟做了什么。如果它包含了如 <code>Array.prototye</code> 的扩展，那删掉就又出问题了。</p><h3 id="如何解决副作用"><a aria-hidden="true" href="#如何解决副作用"><span class="icon icon-link"></span></a>如何解决副作用</h3><p>我们很感谢 Webpack 如此严谨，但如果某个方法就是没有副作用的，我们该怎么告诉 Webpack 让他放心大胆的删除呢？</p><h4 id="pure_funcs"><a aria-hidden="true" href="#pure_funcs"><span class="icon icon-link"></span></a>pure_funcs</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import { foo, bar } from &#x27;./utils&#x27;;

const result1 = foo();

let a = 1;
let b = 2;
let result2 = Math.floor(a / b);

console.log(result1);
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> foo</span><span class="token punctuation">,</span><span class="token plain"> bar </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./utils&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> result2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">floor</span><span class="token punctuation">(</span><span class="token plain">a </span><span class="token operator">/</span><span class="token plain"> b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>utils.js</code> 和之前相同，不再重复。有差别的是 <code>webpack.config.js</code>，需要增加参数 <code>pure_funcs</code>，告诉 Webpack <code>Math.floor</code> 是没有副作用的，你可以放心删除：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="plugins: [
  new UglifyJSPlugin({
    uglifyOptions: {
      compress: {
          pure_funcs: [&#x27;Math.floor&#x27;]
      }
    }
  })
],
" data-status="copy"></button><div class="token-line"><span class="token plain">plugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">UglifyJSPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    uglifyOptions</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      compress</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          pure_funcs</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Math.floor&#x27;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在添加了 <code>pure_funcs</code> 配置后，原来保留的 <code>Math.floor(.5)</code> 被删除了，达到了我们的预期效果。</p><p>但这个方法有一个很大的局限性，在于如果我们把 Webpack 和 Uglify 合并使用，经过 Webpack 的代码的方法名已经被重命名了，那么在这里配置原始的方法名也就失去了意义。而例如 <code>Math.floor</code> 这类全局方法不会重命名，才会生效。因此适用性不算太强。</p><h4 id="packagejson-的-sideeffects"><a aria-hidden="true" href="#packagejson-的-sideeffects"><span class="icon icon-link"></span></a>package.json 的 sideEffects</h4><p>Webpack 4 在 <code>package.json</code> 新增了一个配置项叫做 <code>sideEffects</code>， 值为 <code>false</code> 表示整个包都没有副作用；或者是一个数组列出有副作用的模块。详细的例子可以查看 Webpack 官方提供的 <a href="https://github.com/webpack/webpack/blob/0d4607c68e/examples/side-effects/README.md" target="_blank" rel="noopener noreferrer">示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>从结果来看，如果 <code>sideEffects</code> 值为 <code>false</code>，当前包 <code>export</code> 了 5 个方法，而我们使用了 2 个，剩下 3 个也不会被打包，是符合预期的。但这要求包作者的自觉添加，因此在当前 Webpack 4 推出不久的情况下，局限性也不算小。</p><p>生产环境打包的时候，会默认开启 TreeShaking，如果不设置 <code>sideEffects</code>，某些通过 <code>import</code> 方式引入的 CSS 文件可能不会被打包，因为 TreeShaking 会甩掉引入后未使用的代码。通常，CSS 文件一般都是引入就好，很少使用里面的方法或变量，所以很容易被 Webpack 认为是没有用的代码，从而不会被打包。所以，不希望被 TreeShaking 的文件，请在 <code>sideEffects</code> 中配置与之匹配的正则表达式。</p><div class="__dumi-default-code-block"><pre class="prism-code language-json"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="{
  &quot;sideEffects&quot;: [&quot;*.css&quot;, &quot;*.less&quot;]
}
" data-status="copy"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&quot;*.css&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;*.less&quot;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="concatenatemodule"><a aria-hidden="true" href="#concatenatemodule"><span class="icon icon-link"></span></a>concatenateModule</h4><p>Webpack3 开始加入了<code>webpack.optimize.ModuleConcatenateModulePlugin()</code>，到了 Webpack4 直接作为 <code>mode = &#x27;production&#x27;</code> 的默认配置。这是对 Webpack Bundle 的一个优化，把本来 <strong>每个模块包裹在一个闭包里的情况</strong>，优化成 <strong>所有模块都包裹在同一个闭包里</strong> 的情况。本身对于代码缩小体积有很大的提升，这里也能侧面解决副作用的问题。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import { foo, bar } from &#x27;./utils&#x27;;

const result1 = foo();
const result2 = bar();

console.log(result1);
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> foo</span><span class="token punctuation">,</span><span class="token plain"> bar </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./utils&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// utils.js
export function foo() {
  return &#x27;foo&#x27;;
}

export function bar() {
  return &#x27;bar&#x27;;
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// utils.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;foo&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;bar&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在开启了 concatenateModule 功能后，<code>bar</code> 方法的调用和本体都被消除了，<code>foo</code> 方法的调用和定义被合到一起，变成直接 <code>console.log(&#x27;bar&#x27;)</code>。除此之外，这个功能的原有目的：代码量减少了。</p><p>这个功能的本意是把所有模块最终输出到同一个方法内部，从而把调用和定义合并到一起。这样像 <code>bar()</code> 这样没有副作用的方法就可以在合并之后被轻易识别出来，并加以删除。有关这个功能更加详细的介绍可以看这篇文章</p><h2 id="最佳实践"><a aria-hidden="true" href="#最佳实践"><span class="icon icon-link"></span></a>最佳实践</h2><h3 id="合理模块设计"><a aria-hidden="true" href="#合理模块设计"><span class="icon icon-link"></span></a>合理模块设计</h3><p>合理模块设计才是减少代码体积的关键</p><p>TreeShaking 其实只是一个打包器的特性，良好的模块拆分才是减少代码体积的关键。</p><p>对于 ES6 模块来说，会有 <code>_default export_</code> 和 <code>_named export_</code> 的区别。有些开发者喜欢把所有东西都弄成一个对象塞到 default 里面。<code>_default export_</code> 在概念上来说并不仅仅一个名字叫做 default 的 export，虽然它会被这样转译。把一切东西都塞到 default 里面是一个错误的选择，会让 TreeShaking 无效。从语意上上来说，<code>_default export_</code> 用来说明这个模块是什么，<code>_named export_</code> 用来说明这个模块有什么。合理的模块拆分是一定可以让编译器只打包到所需的代码的。</p><ul><li><strong>使用 ES6 Module</strong>：不仅是项目本身，引入的库最好也是 ES 版本，比如用 <code>lodash-es</code> 代替 <code>lodash</code>。另外注意 TypeScript 和 Babel 的配置是否会把代码编译成非 ES Module 版本。</li><li><strong>最纯函数调用使用 PURE 注释</strong>：由于无法判断副作用，所以对于导出的函数调用最好使用 PURE 注释，不过一般来说有个相关的 babel 插件自动添加。</li></ul><h3 id="实用建议"><a aria-hidden="true" href="#实用建议"><span class="icon icon-link"></span></a>实用建议</h3><ol><li>尽量不屑带有副作用的代码。诸如编写了立即执行函数，在函数里又使用了外部变量等。</li><li>如果对 ES6 语义特性要求不是特别严格，可以开启 Babel 的 <code>loose</code> 模式，这个要根据自身项目判断，如：是否真的要不可枚举 class 的属性。</li><li>如果是开发 JavaScript 库，请使用 rollup。并且提供 ES6 Module 的版本，入口文件地址设置到 <code>package.json</code> 的 <code>module</code> 字段</li><li>如果 JavaScript 库开发中，难以避免地产生各种副作用代码，可以将功能函数或者组件，打包成单独的文件或目录，以便于用户可以通过目录去加载。如有条件，也可为自己的库开发单独的 <code>webpack-loader</code>，便于用户按需加载。</li><li>如果是工程项目开发，对于依赖的组件，只能看组件提供者是否有对应上述 3、4 点的优化。对于自身的代码，除 1、2 两点外，对于项目有极致要求的话，可以先进行打包，最终再进行编译。</li><li>如果对项目非常有把握，可以通过 uglify 的一些编译配置，如：pure_getters: true，删除一些强制认为不会产生副作用的代码。</li></ol><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://webpack.js.org/guides/tree-shaking/" target="_blank" rel="noopener noreferrer">📖 Tree Shaking<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://medium.com/@Rich_Harris/tree-shaking-versus-dead-code-elimination-d3765df85c80" target="_blank" rel="noopener noreferrer">📝 Tree Shaking versus dead code elimination<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5a4dc842518825698e7279a9" target="_blank" rel="noopener noreferrer">📝 Tree-Shaking 性能优化实践：原理篇（2018 年 01 月 04 日）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5a4dca1d518825128654fa78" target="_blank" rel="noopener noreferrer">📝 TTree-Shaking 性能优化实践：实践篇（2018 年 01 月 04 日）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://zhuanlan.zhihu.com/p/32831172" target="_blank" rel="noopener noreferrer">📝 T 你的 TreeShaking 并没什么卵用（2018 年 01 月 11 日）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5b8ce49df265da438151b468" target="_blank" rel="noopener noreferrer">📝 体积减少 80%!释放 webpack tree-shaking 的真正潜力<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://zhuanlan.zhihu.com/p/43844419" target="_blank" rel="noopener noreferrer">📝 浅谈 ES 模块和 Webpack Tree-shaking（2018 年 09 月 09 日）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://github.com/lin-xi/webpack-css-treeshaking-plugin" target="_blank" rel="noopener noreferrer">🛠 webpack-css-treeshaking-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://github.com/vincentdchan/webpack-deep-scope-analysis-plugin" target="_blank" rel="noopener noreferrer">🛠 webpack-deep-scope-analysis-plugin：<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/Webpack-Guidebook/edit/master/docs/principle-analysis/operational-principle/tree-shaking.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/18/2020, 10:19:07 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/webpack-guidebook/umi.js"></script>
    <script src="/webpack-guidebook/docs__principle-analysis__operational-principle__tree-shaking.md.js"></script>
  </body>
</html>
