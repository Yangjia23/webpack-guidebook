<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/webpack-guidebook/umi.css" />
    <script>
      window.routerBase = "/webpack-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.20
    </script>
    <title>作用域提升</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//">Webpack Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/webpack-guidebook//basic-summary">基本综述</a><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a><a href="/webpack-guidebook//best-practice">最佳实践</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//"></a><h1>Webpack Guidebook</h1><p>Webpack 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/webpack-guidebook//basic-summary">基本综述</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a></li><li><a href="/webpack-guidebook//best-practice">最佳实践</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/webpack-guidebook//principle-analysis/babel">Babel</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/operational-principle">工作原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/operational-principle/file-watch"><span>文件监听</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement"><span>模块热更新</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/filenames-hashes"><span>文件指纹策略</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking"><span>Tree Shaking</span></a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting"><span>作用域提升</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/sourcemap"><span>SourceMap</span></a></li></ul></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle">底层原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/workflow"><span>构建流程</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/simple-implementation"><span>简易实现</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/source-code-analysis"><span>源码分析</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/tapable"><span>Tapable</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compiler"><span>Compiler</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compilation"><span>Compilation</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader"><span>Loader 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin"><span>Plugin 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/ast"><span>抽象语法树</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="模块构建" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting#模块构建"><span>模块构建</span></a></li><li title="模块转换分析" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting#模块转换分析"><span>模块转换分析</span></a></li><li title="进一步分析 Webpack 的模块机制" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting#进一步分析-webpack-的模块机制"><span>进一步分析 Webpack 的模块机制</span></a></li><li title="实现原理" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting#实现原理"><span>实现原理</span></a></li><li title="使用方法" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting#使用方法"><span>使用方法</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="作用域提升"><a aria-hidden="true" href="#作用域提升"><span class="icon icon-link"></span></a>作用域提升</h1><p>可以简单地把 Scope Hoisting 理解为把每个模块被 Webpack 处理成模块初始化函数整理到一个统一的包裹函数里，也就是把多个作用域用一个作用域取代，以减少内存消耗并减少包裹块代码，从每个模块有一个包裹函数变成只有一个包裹函数包裹所有的模块。但是有一个前提就是，当模块的引用次数大于 1 时，比如被引用了两次或以上，那么这个效果会无效，这是因为被引用多次即这个模块代码会被内联多次，从而增加了打包出来的 JS Bundle 体积。也就是被引用多次的模块在被 Webpack 处理后，会被独立的包裹函数所包裹。</p><p>为什么要作用域提升？</p><ul><li>大量函数闭包包裹代码，导致体积增大（模块越多越明显）</li><li>运行代码时创建的函数作用域变多，内存开销变大</li></ul><h2 id="模块构建"><a aria-hidden="true" href="#模块构建"><span class="icon icon-link"></span></a>模块构建</h2><h3 id="模块转换分析"><a aria-hidden="true" href="#模块转换分析"><span class="icon icon-link"></span></a>模块转换分析</h3><p>Webpack 在对我们的代码进行打包构建时，会把我们的代码打包成什么样子呢？</p><p>以下面代码为例，<code>helloworld.js</code> 输出一个返回 <code>helloworld</code> 字符串的 <code>helloworld</code> 函数，在入口文件执行并使用 <code>document.write</code> 方法写入 HTML 文档。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// index.js
import { helloworld } from &#x27;./helloworld&#x27;;
import &#x27;../../common&#x27;;

document.write(helloworld());
" data-status="copy"></button><div class="token-line"><span class="token comment">// index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> helloworld </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./helloworld&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token string">&#x27;../../common&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token function">helloworld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上述代码经过 Webpack 打包构建后会将模块转换为 <strong>模块初始化函数</strong>：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="(function(module, __webpack_exports__, __webpack_require__) {
  /* 执行代码 */
});
" data-status="copy"></button><div class="token-line"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_exports__</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_require__</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/* 执行代码 */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在模块初始化函数内主要做了以下两件事情：</p><ul><li>被 Webpack 转换后的模块会带上一层包裹</li><li><code>import</code> 会被转换成 <code>__webpack_require__</code></li></ul><h3 id="进一步分析-webpack-的模块机制"><a aria-hidden="true" href="#进一步分析-webpack-的模块机制"><span class="icon icon-link"></span></a>进一步分析 Webpack 的模块机制</h3><p>各个模块被独立打包后，汇集成 <code>modules</code> 作为参数传入一个匿名函数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="(function(modules) {
  // 模块缓存
  var installedModules = {};

  // 引入函数
  function __webpack_require__(moduleId) {
    // 检查模块是否缓存
    if (installedModules[moduleId]) {
      return installedModules[moduleId].exports;
    }

    // 创建新模块（并放入缓存中）
    var module = (installedModules[moduleId] = {
      i: moduleId,
      l: false,
      exports: {},
    });

    // 执行模块函数
    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);

    // 模块加载标识
    module.l = true;

    // 返回导出的模块
    return module.exports;
  }

  // 其他模块方法，后面省略...

  // 启动程序
  __webpack_require__(0);
})([
  /* 0 module */
  function(module, __webpack_exports__, __webpack_require__) {
    //...
  },
  /* 1 module */
  function(module, __webpack_exports__, __webpack_require__) {
    //...
  },
]);
" data-status="copy"></button><div class="token-line"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 模块缓存</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> installedModules </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 引入函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 检查模块是否缓存</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">installedModules</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> installedModules</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 创建新模块（并放入缓存中）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> module </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">installedModules</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      i</span><span class="token punctuation">:</span><span class="token plain"> moduleId</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      l</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      exports</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 执行模块函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    modules</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">,</span><span class="token plain"> module</span><span class="token punctuation">,</span><span class="token plain"> module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">,</span><span class="token plain"> __webpack_require__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 模块加载标识</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    module</span><span class="token punctuation">.</span><span class="token property-access">l</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 返回导出的模块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 其他模块方法，后面省略...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 启动程序</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/* 0 module */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_exports__</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_require__</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/* 1 module */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_exports__</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_require__</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>分析：</p><ul><li>打包出来的是一个 IIFE（匿名闭包）</li><li><code>modules</code> 是一个数组，每项是一个模块初始化函数</li><li><code>__webpack_require__</code> 用来加载模块，返回 <code>module.exports</code></li><li>通过 <code>WEBPACK_REQUIRE_METHOD(0)</code> 启动程序</li></ul><p>更深入的分析可以看这篇文章：<a href="https://zhuanlan.zhihu.com/p/25954788" target="_blank" rel="noopener noreferrer">从 Bundle 文件看 Webpack 模块机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>简单来说，Webpack 将所有模块都用函数包裹起来，然后实现了一套模块加载、执行与缓存的功能，使用这样的结构是为了更容易实现 <a href="https://webpack.js.org/guides/code-splitting/" target="_blank" rel="noopener noreferrer">Code Splitting<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（包括<a href="https://webpack.js.org/guides/code-splitting/#dynamic-imports" target="_blank" rel="noopener noreferrer">按需加载<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）、<a href="https://webpack.js.org/concepts/hot-module-replacement/" target="_blank" rel="noopener noreferrer">模块热更新<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>等功能。</p><p>但如果你在 Webpack 3 中添加了 ModuleConcatenationPlugin 插件，这个结构会发生一些变化。</p><h2 id="实现原理"><a aria-hidden="true" href="#实现原理"><span class="icon icon-link"></span></a>实现原理</h2><p>同样的源文件在使用了 ModuleConcatenationPlugin 之后，打包出来的文件会变成下面这样：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="({
  &#x27;./src/index.js&#x27;: function(module, __webpack_exports__, __webpack_require__) {
    &#x27;use strict&#x27;;
    eval(/* 模块代码 */);
  },
  &#x27;./src/helloworld.js&#x27;: function(module, __webpack_exports__, __webpack_require__) {
    &#x27;use strict&#x27;;
    eval(/* 模块代码 */);
  },
  /* 其他模块 */
});
" data-status="copy"></button><div class="token-line"><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;./src/index.js&#x27;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_exports__</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_require__</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;use strict&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token comment">/* 模块代码 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;./src/helloworld.js&#x27;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_exports__</span><span class="token parameter punctuation">,</span><span class="token parameter"> __webpack_require__</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;use strict&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token comment">/* 模块代码 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/* 其他模块 */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>显而易见，这次 Webpack 将所有模块都放在了一个函数里，直观感受就是——函数声明少了很多，因此而带来的好处有：</p><ol><li>文件体积比之前更小。</li><li>运行代码时创建的函数作用域也比之前少了，开销也随之变小。</li></ol><p>项目中的模块越多，上述的两点提升就会越明显。</p><p>📌 实现原理：将所有模块的代码按照引用顺序放在一个函数的作用域里，然后适当地重命名一些变量以防止变量名冲突。</p><p>对比：通过 Scope Hoisting 可以减少函数声明代码和内存开销</p><p>暂不支持 CommonJS 模块语法的原因是，这种模块语法中的模块是可以动态加载的，例如下面这段代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var directory = &#x27;./modules/&#x27;;
if (Math.random() &gt; 0.5) {
  module.exports = require(directory + &#x27;foo.js&#x27;);
} else {
  module.exports = require(directory + &#x27;bar.js&#x27;);
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> directory </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;./modules/&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token plain">directory </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;foo.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token plain">directory </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;bar.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这种情况很难分析出模块之间的依赖关系及输出的变量。</p><p>而 ES2015 的模块语法规定 <code>import</code> 和 <code>export</code> 关键字必须在顶层、模块路径只能用字符串字面量，这种 <strong>强制静态化</strong> 的做法使代码在编译时就能确定模块的依赖关系，以及输入和输出的变量，所以这种功能实现起来会更加简便。</p><p>不过，未来 Webpack 可能也会支持 CommonJS 的模块语法。</p><h2 id="使用方法"><a aria-hidden="true" href="#使用方法"><span class="icon icon-link"></span></a>使用方法</h2><p>在 Webpack 3 需要手动添加代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="modules.exports = {
  plugins: [new webpack.optimize.ModuleConcatenationPlugin()],
};
" data-status="copy"></button><div class="token-line"><span class="token plain">modules</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">webpack</span><span class="token class-name punctuation">.</span><span class="token class-name">optimize</span><span class="token class-name punctuation">.</span><span class="token class-name">ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在 Webpack4 只需要将 <code>mode</code> 设置为 <code>production</code> 将会自动使用 Scope Hoisting，其次必须使用 ES6 语法，CJS 不支持这种特性。</p><p>但也有可能项目中添加上了 ModuleConcatenationPlugin 之后，打包出来的代码完全没有发生变化。</p><p>这种情况发生的原因：</p><ul><li>大部分 NPM 包仍然是 CommoJS 语法（例如 <a href="https://lodash.com/" target="_blank" rel="noopener noreferrer">lodash<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</li><li>使用了 <a href="https://webpack.js.org/plugins/provide-plugin/" target="_blank" rel="noopener noreferrer">ProvidePlugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li>使用了 <code>eval()</code> 函数</li><li>你的项目有多个 <code>entry</code></li></ul><p>运行 Webpack 时加上 <code>--display-optimization-bailout</code> 参数可以得知为什么你的项目无法使用 Scope Hoisting：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="webpack --display-optimization-bailout
" data-status="copy"></button><div class="token-line"><span class="token plain">webpack --display-optimization-bailout</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>另外，当你使用这个插件的时候，模块热更新将不起作用，所以最好只在代码优化的时候才使用这个插件。</p><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://zhuanlan.zhihu.com/p/27980441" target="_blank" rel="noopener noreferrer">📝 Webpack 3 的新功能：Scope Hoisting（2017-07-20）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/Webpack-Guidebook/edit/master/docs/principle-analysis/operational-principle/scope-hoisting.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/18/2020, 10:19:07 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/webpack-guidebook/umi.js"></script>
    <script src="/webpack-guidebook/docs__principle-analysis__operational-principle__scope-hoisting.md.js"></script>
  </body>
</html>
